<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Dashboard - Real-time Statistics</title>
</head>
<body>

    <header>
        <h1>Server Dashboard</h1>
        <p>Real-time Performance Monitoring</p>
        <p><small>Last update: <span id="lastUpdate">--</span></small></p>
    </header>


    <hr>

    <main>
        <h2>Current Statistics</h2>
        
        <ul>
            <li>
                <h3>Total Requests</h3>
                <p><strong>Value:</strong> <span id="totalRequests">0</span></p>
                <p><em>Since server start</em></p>
            </li>

            <li>
                <h3>Successful (200 OK)</h3>
                <p><strong>Value:</strong> <span id="requests200">0</span></p>
                <p><em><span id="percent200">0% of total</span></em></p>
            </li>

            <li>
                <h3>Not Found (404)</h3>
                <p><strong>Value:</strong> <span id="requests404">0</span></p>
                <p><em><span id="percent404">0% of total</span></em></p>
            </li>

            <li>
                <h3>Server Errors (500)</h3>
                <p><strong>Value:</strong> <span id="requests500">0</span></p>
                <p><em><span id="percent500">0% of total</span></em></p>
            </li>

            <li>
                <h3>Data Transferred</h3>
                <p><strong>Value:</strong> <span id="bytesServed">0 MB</span></p>
                <p><em>Total bandwidth used</em></p>
            </li>

            <li>
                <h3>Cache Performance</h3>
                <p><strong>Value:</strong> <span id="cacheHitRate">0%</span></p>
                <p><em><span id="cacheHits">0</span> hits / <span id="cacheMisses">0</span> misses</em></p>
            </li>

            <li>
                <h3>Server Uptime</h3>
                <p><strong>Value:</strong> <span id="uptime">0h 0m</span></p>
                <p><em>Time since server start</em></p>
            </li>

            <li>
                <h3>Average Response Time</h3>
                <p><strong>Value:</strong> <span id="avgResponseTime">0ms</span></p>
                <p><em>Average request latency</em></p>
            </li>

            <li>
                <h3>Requests Per Second</h3>
                <p><strong>Value:</strong> <span id="reqPerSec">0 req/s</span></p>
                <p><em>Current throughput</em></p>
            </li>
        </ul>

        <hr>

    </main>
    
    <footer>
        <p>Bernardo Coelho 125059 - Tiago Vale 125913</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let autoRefresh = true;
        let refreshInterval;
        let timeSeriesData = [];
        const maxDataPoints = 20;
        let serverStartTime = Date.now();

        // Initialize charts
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#333' }
                    }
                },
                scales: {
                    y: {
                        ticks: { color: '#666' },
                        grid: { color: '#ddd' }
                    },
                    x: {
                        ticks: { color: '#666' },
                        grid: { color: '#ddd' }
                    }
                }
            };

        }

        // Fetch stats from server (mock data for now)
        async function fetchStats() {
            try {
                // Try to fetch from actual endpoint
                const response = await fetch('/api/stats');
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.log('Using mock data');
            }

            // Mock data generator for demonstration
            const mock = {
                total_requests: Math.floor(Math.random() * 1000) + 500,
                status_200: Math.floor(Math.random() * 800) + 400,
                status_404: Math.floor(Math.random() * 150) + 50,
                status_500: Math.floor(Math.random() * 50) + 10,
                bytes_served: Math.floor(Math.random() * 1000000000),
                cache_hits: Math.floor(Math.random() * 600) + 300,
                cache_misses: Math.floor(Math.random() * 200) + 100
            };
            
            return mock;
        }

        // Update dashboard with new data
        async function updateDashboard() {
            const stats = await fetchStats();
            
            // Update cards
            document.getElementById('totalRequests').textContent = stats.total_requests.toLocaleString();
            document.getElementById('requests200').textContent = stats.status_200.toLocaleString();
            document.getElementById('requests404').textContent = stats.status_404.toLocaleString();
            document.getElementById('requests500').textContent = stats.status_500.toLocaleString();
            
            // Calculate percentages
            const total = stats.total_requests || 1;
            document.getElementById('percent200').textContent = 
                `${((stats.status_200 / total) * 100).toFixed(1)}% of total`;
            document.getElementById('percent404').textContent = 
                `${((stats.status_404 / total) * 100).toFixed(1)}% of total`;
            document.getElementById('percent500').textContent = 
                `${((stats.status_500 / total) * 100).toFixed(1)}% of total`;
            
            // Bytes served
            const mb = (stats.bytes_served / (1024 * 1024)).toFixed(2);
            document.getElementById('bytesServed').textContent = `${mb} MB`;
            
            // Cache stats
            const cacheTotal = stats.cache_hits + stats.cache_misses || 1;
            const hitRate = ((stats.cache_hits / cacheTotal) * 100).toFixed(1);
            document.getElementById('cacheHitRate').textContent = `${hitRate}%`;
            document.getElementById('cacheHits').textContent = stats.cache_hits.toLocaleString();
            document.getElementById('cacheMisses').textContent = stats.cache_misses.toLocaleString();
            
            
            // Update time series
            const now = new Date().toLocaleTimeString();
            timeSeriesData.push({ time: now, requests: stats.total_requests });
            if (timeSeriesData.length > maxDataPoints) {
                timeSeriesData.shift();
            }
            
            
            // Update timestamp
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            
            // Update uptime
            const uptimeMs = Date.now() - serverStartTime;
            const hours = Math.floor(uptimeMs / 3600000);
            const minutes = Math.floor((uptimeMs % 3600000) / 60000);
            document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
            
            // Mock additional stats
            document.getElementById('avgResponseTime').textContent = 
                `${(Math.random() * 100 + 10).toFixed(0)}ms`;
            document.getElementById('reqPerSec').textContent = 
                `${(stats.total_requests / (uptimeMs / 1000)).toFixed(2)} req/s`;
        }



        

        

        

        // Initialize on page load
        window.addEventListener('load', () => {
            initCharts();
            updateDashboard();
            startAutoRefresh();
        });
    </script>

</body>
</html>